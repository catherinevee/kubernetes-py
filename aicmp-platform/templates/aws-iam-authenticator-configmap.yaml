{{- if and .Values.awsIamAuthenticator.enabled .Values.awsIamAuthenticator.configMap.create }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.awsIamAuthenticator.configMap.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "common.labels" . | nindent 4 }}
    app.kubernetes.io/component: "aws-iam-authenticator"
  annotations:
    {{- include "common.annotations" . | nindent 4 }}
data:
  config.yaml: |
    # AWS IAM Authenticator Configuration
    # Generated by Helm chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    
    # Cluster configuration
    clusterID: {{ .Values.awsIamAuthenticator.config.clusterID | quote }}
    
    # Server configuration
    server:
      port: {{ .Values.awsIamAuthenticator.config.server.port }}
      stateDir: {{ .Values.awsIamAuthenticator.config.server.stateDir | quote }}
      generateKubeconfig: {{ .Values.awsIamAuthenticator.config.server.generateKubeconfig | quote }}
    
    # Map IAM roles to Kubernetes users/groups
    mapRoles:
    {{- range .Values.awsIamAuthenticator.config.mapRoles }}
      - roleARN: {{ .roleARN | quote }}
        username: {{ .username | quote }}
        groups:
        {{- range .groups }}
          - {{ . | quote }}
        {{- end }}
    {{- end }}
    
    # Map IAM users to Kubernetes users/groups
    mapUsers:
    {{- range .Values.awsIamAuthenticator.config.mapUsers }}
      - userARN: {{ .userARN | quote }}
        username: {{ .username | quote }}
        groups:
        {{- range .groups }}
          - {{ . | quote }}
        {{- end }}
    {{- end }}
    
    # Map AWS accounts to Kubernetes users/groups
    mapAccounts:
    {{- range .Values.awsIamAuthenticator.config.mapAccounts }}
      - {{ . | quote }}
    {{- end }}
{{- end }} 